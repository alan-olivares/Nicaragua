<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>TBRE</title>
      <link rel="icon" href="img\TBRE.ico">
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
      <link href="css/plugins/datapicker/datepicker3.css" rel="stylesheet">
      <!-- Toastr style -->
      <link href="css/plugins/toastr/toastr.min.css" rel="stylesheet">
      <!-- Gritter -->
      <link href="js/plugins/gritter/jquery.gritter.css" rel="stylesheet">
      <link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
      <link href="css/animate.css" rel="stylesheet">
      <link href="css/style.css" rel="stylesheet">
   </head>
   <body>
      <script src="js/revisar_sesion.js"></script>
      <div id="wrapper">
      <nav class="navbar-default navbar-static-side" role="navigation">
         <div class="sidebar-collapse">
            <ul class="nav metismenu" id="side-menu">
               <li class="nav-header">
                  <div class="dropdown profile-element">
                     <img alt="image" class="rounded-circle perfil" id="perfil1"/>
                     <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                        <span class="block m-t-xs font-bold">
                           <script>
                              document.write(localStorage['nombre'] || 'Sin nombre');
                              var foto=localStorage['nombre'] || 'Sin nombre';
                              foto=foto.charAt(0).concat(".png").toLowerCase();
                              document.getElementById("perfil1").src="img/letras/"+foto;
                           </script>
                        </span>
                        <span class="text-muted text-xs block">
                           <script>
                              document.write(localStorage['perfil'] || 'Sin perfil');
                           </script><b class="caret"></b>
                        </span>
                     </a>
                     <ul class="dropdown-menu animated fadeInRight m-t-xs">
                        <li><a class="dropdown-item" href="perfil.html">Perfil</a></li>
                        <li class="dropdown-divider"></li>
                        <li><a class="dropdown-item" onclick="limpiar();">Cerrar sesión</a></li>
                     </ul>
                  </div>
                  <div class="logo-element">
                     TBRE
                  </div>
               </li>
               <li class="active once">
                  <a href="index.html"><i class="fa fa-area-chart"></i> <span class="nav-label">Operación del día</span></a>
               </li>
               <li class="diez">
                  <a href="#"><i class="fa fa-table"></i> <span class="nav-label">Reportes</span><span class="fa arrow"></span></a>
                  <ul class="nav nav-second-level">
                    <li><a href="inventario.html">Inventario</a></li>
                    <li><a href="barriles_plantel.html">Barriles en plantel</a></li>
                    <li><a href="tanques_plantel.html">Tanques en plantel</a></li>
                    <li><a href="llenados.html">Barriles llenados</a></li>
                    <li><a href="rellenados.html">Barriles rellenados</a></li>
                    <li><a href="trasiego.html">Barriles trasegados</a></li>
                    <li><a href="trasiegoHoover.html">T. Hoover llenados</a></li>
                    <li><a href="RGerencia.html">Reporte de Gerencia</a></li>
                  </ul>
               </li>
               <li class="dos">
                  <a href="#"><i class="fa fa-desktop"></i> <span class="nav-label">Validar información</span><span class="fa arrow"></span></a>
                  <ul class="nav nav-second-level">
                     <li><a href="VI_barriles.php">Barriles</a></li>
                     <li><a href="VI_hoover.php">Tanques Hoover</a></li>
                  </ul>
               </li>
               <li class="cinco">
                  <a href="impresion.html"><i class="fa fa-print"></i> <span class="nav-label">Impresión de etiquetas</span></a>
               </li>
               <li class="seis">
                  <a href="#"><i class="fa fa-briefcase"></i> <span class="nav-label">Órdenes de trabajo</span><span class="fa arrow"></span></a>
                  <ul class="nav nav-second-level">
                    <li>
                        <a href="#">Llenado<span class="fa arrow"></span></a>
                        <ul class="nav nav-third-level">
                            <li><a href="OLlenado.html">Orden Llenado</a></li>
                            <li><a href="RLlenadoLlenada.html">Reporte de Llenado</a></li>
                            <li><a href="RLlenadoMantenimineto.html">Reporte de Mantenimiento</a></li>
                            <li><a href="RLlenadoRevisado.html">Reporte de Revisado</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#">Relleno<span class="fa arrow"></span></a>
                        <ul class="nav nav-third-level">
                            <li><a href="ORelleno.html">Orden Relleno</a></li>
                            <li><a href="RRellenoOperacion.html">Reporte de Operación</a></li>
                        </ul>
                    </li>
                    <li><a href="revision.html">Revisión</a></li>
                    <li>
                        <a href="#">Trasiego<span class="fa arrow"></span></a>
                        <ul class="nav nav-third-level">
                             <li><a href="OTrasiego.html">Orden Trasiego</a></li>
                             <li><a href="RTrasiegoHojaAnalisis.html">Hoja de Análisis de Trasiego</a></li>
                             <li><a href="RTrasiegoVaciados.html">Barriles vaciados por trasiego</a></li>
                             <li><a href="RTrasiegoRemision.html">Remisión blending</a></li>
                        </ul>
                    </li>
                    <li><a href="OTrasiegoHoover.html">Trasiego Hoover</a></li>
                  </ul>
               </li>
               <li class="ocho">
                  <a href="#"><i class="fa fa-inbox"></i> <span class="nav-label">Recepción</span><span class="fa arrow"></span></a>
                  <ul class="nav nav-second-level collapse">
                     <li><a href="RAlcohol.html">Alcohol</a></li>
                     <li><a href="RBarriles.html">Barriles</a></li>
                     <li><a href="RTanquesHoover.html">Tanques Hoover</a></li>
                  </ul>
               </li>
               <li class="uno-dos">
                  <a href="#"><i class="fa fa-bell"></i> <span class="nav-label">Solicitudes</span><span class="fa arrow"></span><span class="label label-primary float-right uno" style="margin-right:15px;"id="letrero1">0</span></a>
                  <ul class="nav nav-second-level collapse">
                     <li><a href="pendientes.html">Pendientes <span class="label label-primary float-right uno" id="letrero2">0</span></a></li>
                     <li><a href="aceptadas.html">Aceptadas</a></li>
                     <li><a href="rechazadas.html">Rechazadas</a></li>
                     <li><a href="canceladas.html">Canceladas</a></li>
                  </ul>
               </li>
               <li class="siete">
                  <a href="disenoAlmacen.html"><i class="fa fa-building"></i> <span class="nav-label">Diseñar almacenes</span></a>
               </li>
               <li class="nueve">
                 <a href="#"><i class="fa fa-edit"></i> <span class="nav-label">Ajustes de inventario</span><span class="fa arrow"></span></a>
                 <ul class="nav nav-second-level collapse">
                    <li><a href="AjustesInventario.html">Inventario</a></li>
                    <li><a href="AjustesLlenado.html">Llenado</a></li>
                    <li><a href="AjustesRelleno.html">Relleno</a></li>
                 </ul>
               </li>
               <li class="tres-cuatro">
                  <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Administración</span><span class="fa arrow"></span></a>
                  <ul class="nav nav-second-level">
                     <li class="tres"><a href="usuarios.html">Usuarios</a></li>
                     <li class="cuatro"><a href="configuracion.html">Configuración</a></li>
                  </ul>
               </li>
            </ul>
         </div>
      </nav>
      <div id="page-wrapper" class="gray-bg">
         <div class="row border-bottom">
            <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
               <div class="navbar-header">
                  <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
               </div>
               <h2 class="nav navbar-top-links titulo welcome-message">TBRE - Operación del día</h2>
               <ul class="nav navbar-top-links navbar-right">
                  <li class="dropdown uno">
                     <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                     <i class="fa fa-bell"></i>  <span class="label label-primary" id="letrero3">0</span>
                     </a>
                     <ul class="dropdown-menu dropdown-alerts">
                        <li>
                           <a href="pendientes.html" class="dropdown-item">
                              <div id="letrero4">
                                 <i class="fa fa-envelope fa-fw" ></i> Tienes 0 solicitudes de cambios
                              </div>
                           </a>
                        </li>
                     </ul>
                  </li>
                  <li>
                     <a onclick="javascript:limpiar();">
                     <i class="fa fa-sign-out"></i> Cerrar sesión
                     </a>
                  </li>
               </ul>
            </nav>
         </div>
         <div class="row text-center border-bottom white-bg dashboard-header d-flex justify-content-center">
            <div class="" style="float:right;">
               <button class="button4 btn btn-primary" onclick="cambiarBoton(this,'date')" id="diaB">Día</button>
               <button class="button4 btn-outline btn btn-primary" onclick="cambiarBoton(this,'week')" id="semanaB">Semana</button>
               <button class="button4 btn-outline btn btn-primary" onclick="cambiarBoton(this,'month')" id="mesB">Mes</button>
            </div>
            <div class="col-md-11 ">
               <div class="form-inline text-center d-flex justify-content-center">
                  <h5><label class="">Fecha:</label>
                     <input type="date" class="form-control" value="" id="date1" onchange="obtenerDatos()" onkeydown="return false">
                  </h5>
               </div>
               <div class="flot-chart dashboard-chart ">
                  <div class="flot-chart-content " id="flot-dashboard-chart"></div>
               </div>
               <div class="row text-center">
                  <div class="col">
                     <div class=" m-l-md">
                        <span class="h5 font-bold m-t block" style="color:#1ab394" id="BLLT">0</span>
                        <h5 class="text-muted m-b block">Barriles llenados</h5>
                     </div>
                  </div>
                  <div class="col">
                     <span class="h5 font-bold m-t block" style="color:#1C84C6" id="BRT">0</span>
                     <h5 class="text-muted m-b block">Barriles rellenados</h5>
                  </div>
                  <div class="col">
                     <span class="h5 font-bold m-t block" style="color:#f8ac59" id="BTT">0</span>
                     <h5 class="text-muted m-b block">Barriles trasegados</h5>
                  </div>
                  <div class="col">
                     <span class="h5 font-bold m-t block" style="color:#ed5565" id="BRE">0</span>
                     <h5 class="text-muted m-b block">Barriles reparados</h5>
                  </div>
                  <div class="col">
                     <span class="h5 font-bold m-t block" style="color:#daed07" id="TLL">0</span>
                     <h5 class="text-muted m-b block">T. Hoover llenados</h5>
                  </div>
               </div>
            </div>
         </div>
         <div class="wrapper wrapper-content">
            <div class="footer">
               <div>
                  <strong>Todos los derechos reservados | </strong>SER Licorera 2014
               </div>
            </div>
         </div>
      </div>
      <!-- Mainly scripts -->
      <script src="js/jquery-3.1.1.min.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.js"></script>
      <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
      <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
      <!-- Flot -->
      <script src="js/plugins/flot/jquery.flot.js"></script>
      <script src="js/plugins/flot/jquery.flot.tooltip.min.js"></script>
      <script src="js/plugins/flot/jquery.flot.spline.js"></script>
      <script src="js/plugins/flot/jquery.flot.resize.js"></script>
      <script src="js/plugins/flot/jquery.flot.pie.js"></script>
      <!-- Toastr -->
      <script src="js/plugins/toastr/toastr.min.js"></script>
      <!-- Custom and plugin javascript -->
      <script src="js/inspinia.js"></script>
      <script src="js/plugins/pace/pace.min.js"></script>
      <!-- ChartJS-->
      <script src="js/plugins/chartJs/Chart.min.js"></script>
      <script src="js/abrir_ventana.js"></script>
      <!-- Data picker -->
      <script src="js/plugins/datapicker/bootstrap-datepicker.js"></script>
      <script src="js/plugins/sweetalert/sweetalert.min.js"></script>
      <script src="js/funciones_generales.js"></script>

      <script>
        const getApi="get_index.php";
        var caso="date";
        function cambiarBoton(boton,tipo){
          $('#diaB').addClass('btn-outline');
          $('#mesB').addClass('btn-outline');
          $('#semanaB').addClass('btn-outline');
          $(boton).removeClass('btn-outline');
          var fecha=document.getElementById("date1").valueAsDate;
          $('#date1').get(0).type = tipo;
          document.getElementById("date1").valueAsDate= fecha;
          caso=tipo;
          obtenerDatos();
        }

        function crearGrafica(dataset,ticks,mensaje){
          $("#flot-dashboard-chart").length && $.plot($("#flot-dashboard-chart"), dataset,
          {
            series: {
              lines: {
                show: false,
                fill: true
              },
              splines: {
                show: true,
                tension: 0.4,
                lineWidth: 1,
                fill: 0.4
              },
              points: {
                radius: 3,
                show: true
              },
              shadowSize: 1,
            },
            grid: {
              hoverable: true,
              clickable: true,
              tickColor: "#d5d5d5",
              borderWidth: 1,
              color: '#858786'
            },
            colors: ["#1ab394", "#1C84C6","#f8ac59","#ed5565","#daed07"],
            xaxis:{
              min:ticks[0][0],
              max:ticks[ticks.length-1][0],
              ticks: ticks,
            },
            yaxis: {
              ticks: 5
            },
            tooltip: true,
            tooltipOpts : {
              content : function (label, x, y) {
                return mensaje.formatUnicorn(x, y,label);
              },
              defaultTheme : true
            },
          }
        );

        $("#flot-dashboard-chart").on("plotclick",function(event,pos,item){
          if(item){
            var dia=obtenerDia(item.series.data[item.dataIndex][0]);
            var hora1=caso==='date'?item.series.data[item.dataIndex][0]+':00':'00:00';
            var hora2=caso==='date'?item.series.data[item.dataIndex][0]+':59':'23:59';
            var aut='&aut='+btoa(localStorage['usuario'] + ":" + localStorage['password']);
            switch (item.series.label) {
              case "Barriles llenados":
                abrir("descripcion_dia.php?dia="+dia+"&hora1="+dia+" "+hora1+"&hora2="+dia+" "+hora2+"&evento=1&tipo="+item.series.label+aut);
              break;
              case "Barriles rellenados":
                abrir("descripcion_dia.php?dia="+dia+"&hora1="+dia+" "+hora1+"&hora2="+dia+" "+hora2+"&evento=2,4,5&tipo="+item.series.label+aut);
              break;
              case "Barriles trasegados":
                abrir("descripcion_dia.php?dia="+dia+"&hora1="+dia+" "+hora1+"&hora2="+dia+" "+hora2+"&evento=3&tipo="+item.series.label+aut);
              break;
              case "Barriles reparados":
                abrir("descripcion_dia.php?dia="+dia+"&hora1="+dia+" "+hora1+"&hora2="+dia+" "+hora2+"&evento=10&tipo="+item.series.label+aut);
              break;
              case "Tanques Hoover llenados":
                abrir("descripcion_dia.php?dia="+dia+"&hora1="+dia+" "+hora1+"&hora2="+dia+" "+hora2+"&evento=11&tipo="+item.series.label+aut);
              break;
            }
          }
        });
        }
        async function obtenerDatos(){
          try {
            var url='RestApi/GET/'+getApi+'?fecha='+$('#date1').val()+"&"+caso+"=true";
            var result = await conexion("GET",url,"");
            //alert(result)
            console.log(result);
            var dataset =JSON.parse(result);
            crearGrafica(dataset,obtenerTicks(),obtenerMensaje());
            url='RestApi/GET/'+getApi+'?fecha='+$('#date1').val()+"&"+caso+"=true&total=true";
            result = await conexion("GET",url,"");
            var totales =JSON.parse(result);
            insertarTotales(totales);
          } catch (e) {
            mensajeError(e)
          }
        }
        function insertarTotales(json){
          $('#BLLT').text(json[0].llenados);
          $('#BRT').text(json[0].rellenados);
          $('#BTT').text(json[0].trasegados);
          $('#BRE').text(json[0].reparados);
          $('#TLL').text(json[0].Hoover);
        }
        function obtenerTicks(){
          switch (caso) {
            case 'date':
              return [[6, "6:00"], [7, "7:00"], [8, "8:00"], [9, "9:00"], [10, "10:00"], [11, "11:00"], [12, "12:00"], [13, "13:00"], [14, "14:00"], [15, "15:00"]
            , [16, "16:00"], [17, "17:00"], [18, "18:00"], [19, "19:00"]];
            case 'week':
              return [[1, "Lunes"], [2, "Martes"], [3, "Miercoles"], [4, "Jueves"], [5, "Viernes"]];
            case 'month':
              var ticks =[];
              var d = new Date(document.getElementById("date1").valueAsDate);
              for(var i=1;i<=new Date(d.getFullYear(), d.getMonth()+2, 0).getDate();i++){
                ticks.push([i,i]);
              }
              return ticks;
            default:

          }
        }
        function obtenerMensaje(){
          switch (caso) {
            case 'date':
              return "{0}:00 - {1} {2}"
            case 'week':
              return "{1} {2}"
            case 'month':
              return "El día {0} hubo {1} {2}";
          }
        }
        function obtenerDia(dato){
          switch (caso) {
            case 'date':
              return document.getElementById("date1").value;
            case 'week':
              var date = new Date(document.getElementById("date1").valueAsDate);
              date.setDate(date.getDate() + parseInt(dato));
              return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate();
            case 'month':
              return document.getElementById("date1").value+"-"+dato;
          }
        }
        Date.prototype.addDays = function(days) {
          var date = new Date(this.valueOf());
          date.setDate(date.getDate() + days);
          return date;
        }

         $(document).ready(function() {
           permisos(["11"]);
           document.getElementById("date1").valueAsDate= new Date();
           obtenerDatos();
           setTimeout(function() {
               toastr.options = {
                   closeButton: true,
                   progressBar: true,
                   showMethod: 'slideDown',
                   timeOut: 4000
               };
               var today  = new Date();
               var options = {hour: 'numeric',minute:'numeric' , year: "numeric", month: "long", day: "numeric"};
               toastr.success('Información actualizada del día '+today.toLocaleDateString("es-MX",options));
           }, 1300);
         });
      </script>
   </body>
</html>
