<!DOCTYPE html>
<html>
   <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Impresión de etiquetas</title>
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
      <link rel="icon" href="img\TBRE.ico">
      <link href="css/animate.css" rel="stylesheet">
      <link href="css/style.css" rel="stylesheet">
      <link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
      <script src="impresora/BrowserPrint-3.0.216.min.js"></script>
      <script src="impresora/BrowserPrint-Zebra-1.0.216.min.js"></script>
   </head>
   <body>
      <script src="js/revisar_sesion.js"></script>
      <div id="wrapper">
         <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="sidebar-collapse">
               <ul class="nav metismenu" id="side-menu">
                  <li class="nav-header">
                     <div class="dropdown profile-element">
                        <img alt="image" class="rounded-circle perfil" id="perfil1"/>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                           <span class="block m-t-xs font-bold">
                              <script>
                                 document.write(localStorage['nombre'] || 'Sin nombre');
                                 var foto=localStorage['nombre'] || 'Sin nombre';
                                 foto=foto.charAt(0).concat(".png").toLowerCase();
                                 document.getElementById("perfil1").src="img/letras/"+foto;
                              </script>
                           </span>
                           <span class="text-muted text-xs block">
                              <script>
                                 document.write(localStorage['perfil'] || 'Sin perfil');
                              </script><b class="caret"></b>
                           </span>
                        </a>
                        <ul class="dropdown-menu animated fadeInRight m-t-xs">
                           <li><a class="dropdown-item" href="perfil.html">Perfil</a></li>
                           <li class="dropdown-divider"></li>
                           <li><a class="dropdown-item" onclick="limpiar();">Cerrar sesión</a></li>
                        </ul>
                     </div>
                     <div class="logo-element">
                        TBRE
                     </div>
                  </li>
                  <li class="once">
                     <a href="index.html"><i class="fa fa-area-chart"></i> <span class="nav-label">Operación del día</span></a>
                  </li>
                  <li class="diez">
                     <a href="#"><i class="fa fa-table"></i> <span class="nav-label">Reportes</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                       <li><a href="inventario.html">Inventario</a></li>
                       <li><a href="barriles_plantel.html">Barriles en plantel</a></li>
                       <li><a href="tanques_plantel.html">Tanques en plantel</a></li>
                       <li><a href="llenados.html">Barriles llenados</a></li>
                       <li><a href="rellenados.html">Barriles rellenados</a></li>
                       <li><a href="trasiego.html">Barriles trasegados</a></li>
                       <li><a href="trasiegoHoover.html">T. Hoover llenados</a></li>
                       <li><a href="RGerencia.html">Reporte de Gerencia</a></li>
                     </ul>
                  </li>
                  <li class="dos">
                     <a href="#"><i class="fa fa-desktop"></i> <span class="nav-label">Validar información</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li><a href="VI_barriles.php">Barriles</a></li>
                        <li><a href="VI_hoover.php">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="cinco active">
                     <a href="impresion.html"><i class="fa fa-print"></i> <span class="nav-label">Impresión de etiquetas</span></a>
                  </li>
                  <li class="seis">
                     <a href="#"><i class="fa fa-briefcase"></i> <span class="nav-label">Órdenes de trabajo</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                       <li>
                           <a href="#">Llenado<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="OLlenado.html">Orden Llenado</a></li>
                               <li><a href="RLlenadoLlenada.html">Reporte de Llenado</a></li>
                               <li><a href="RLlenadoMantenimineto.html">Reporte de Mantenimiento</a></li>
                               <li><a href="RLlenadoRevisado.html">Reporte de Revisado</a></li>
                           </ul>
                       </li>
                       <li>
                           <a href="#">Relleno<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="ORelleno.html">Orden Relleno</a></li>
                               <li><a href="RRellenoOperacion.html">Reporte de Operación</a></li>
                           </ul>
                       </li>
                       <li><a href="revision.html">Revisión</a></li>
                       <li>
                           <a href="#">Trasiego<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                                <li><a href="OTrasiego.html">Orden Trasiego</a></li>
                                <li><a href="RTrasiegoHojaAnalisis.html">Hoja de Análisis de Trasiego</a></li>
                                <li><a href="RTrasiegoVaciados.html">Barriles vaciados por trasiego</a></li>
                                <li><a href="RTrasiegoRemision.html">Remisión blending</a></li>
                           </ul>
                       </li>
                       <li><a href="OTrasiegoHoover.html">Trasiego Hoover</a></li>
                     </ul>
                  </li>
                  <li class="ocho">
                     <a href="#"><i class="fa fa-inbox"></i> <span class="nav-label">Recepción</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level collapse">
                        <li><a href="RAlcohol.html">Alcohol</a></li>
                        <li><a href="RBarriles.html">Barriles</a></li>
                        <li><a href="RTanquesHoover.html">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="uno-dos">
                     <a href="#"><i class="fa fa-bell"></i> <span class="nav-label">Solicitudes</span><span class="fa arrow"></span><span class="label label-primary float-right uno" style="margin-right:15px;"id="letrero1">0</span></a>
                     <ul class="nav nav-second-level collapse">
                        <li><a href="pendientes.html">Pendientes <span class="label label-primary float-right uno" id="letrero2">0</span></a></li>
                        <li><a href="aceptadas.html">Aceptadas</a></li>
                        <li><a href="rechazadas.html">Rechazadas</a></li>
                        <li><a href="canceladas.html">Canceladas</a></li>
                     </ul>
                  </li>
                  <li class="siete">
                     <a href="disenoAlmacen.html"><i class="fa fa-building"></i> <span class="nav-label">Diseñar almacenes</span></a>
                  </li>
                  <li class="nueve">
                    <a href="#"><i class="fa fa-edit"></i> <span class="nav-label">Ajustes de inventario</span><span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level collapse">
                       <li><a href="AjustesInventario.html">Inventario</a></li>
                       <li><a href="AjustesLlenado.html">Llenado</a></li>
                       <li><a href="AjustesRelleno.html">Relleno</a></li>
                    </ul>
                  </li>
                  <li class="tres-cuatro">
                     <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Administración</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li class="tres"><a href="usuarios.html">Usuarios</a></li>
                        <li class="cuatro"><a href="configuracion.html">Configuración</a></li>
                     </ul>
                  </li>
               </ul>
            </div>
         </nav>
         <div id="page-wrapper" class="gray-bg">
            <div class="row border-bottom">
               <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                  <div class="navbar-header">
                     <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
                  </div>
                  <h2 class="nav navbar-top-links welcome-message" style="margin-left:90px; margin-right:10px;">Imprimir etiquetas</h2>
                  <ul class="nav navbar-top-links navbar-right">
                     <li class="dropdown uno">
                        <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                        <i class="fa fa-bell"></i>  <span class="label label-primary" id="letrero3">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-alerts">
                           <li>
                              <a href="pendientes.html" class="dropdown-item">
                                 <div id="letrero4">
                                    <i class="fa fa-envelope fa-fw" ></i> Tienes 0 solicitudes de cambios
                                 </div>
                              </a>
                           </li>
                        </ul>
                     </li>
                     <li>
                        <a onclick="javascript:limpiar();">
                        <i class="fa fa-sign-out"></i> Cerrar sesión
                        </a>
                     </li>
                  </ul>
               </nav>
            </div>
            <div class="panel panel-default" style="margin-top:40px;">
               <div class="panel-heading">
                  <h4 class="panel-title">Imprimir etiquetas</h4>
               </div>
               <div class="panel-body">
                  <div class="col-md-12 text-center  d-flex justify-content-center" >
                    <div class="col-md-3 text-center" >
                       <h5><label>  Tipo:   </label>
                          <select class="form-control b-r-xl" id="tipo" onchange="cambioTipo(this);">
                            <option value="01">Barril</option>
                            <option value="02">Tanque Hoover</option>
                          </select>
                       </h5>
                    </div>
                     <div class="col-md-3 text-center" >
                        <h5><label>  N° de copias:   </label>
                           <input type="number" class="form-control b-r-xl" required="true" name="copias" id="copias">
                        </h5>
                     </div>
                     <div class="col-md-3 text-center" >
                        <h5><label>  Folio Inicial:   </label>
                           <input type="number" class="form-control b-r-xl" onchange="autoComplete(this);" required="true" name="Inicial" id="Inicial">
                        </h5>
                     </div>
                     <div class="col-md-3 text-center" >
                        <h5><label>  Folio Final:   </label>
                           <input type="number" class="form-control b-r-xl" required="true" name="Final" id="Final">
                        </h5>
                     </div>
                  </div>
                  <div class="col-md-12 text-center  d-flex justify-content-center" >
                     <button class="button5 btn btn-primary b-r-xl" onclick="Generar('CLN','CLNCuerpo',true);">Imprimir registro</button>
                     <button class="button5 btn btn-primary b-r-xl" onclick="Generar('Folio','FolioCuerpo',false);">Imprimir folios</button>
                  </div>
               </div>
            </div>
            <div class="footer">
               <div>
                  <strong>Todos los derechos reservados | </strong>SER Licorera 2014
               </div>
            </div>
         </div>
      </div>
      <!-- Mainly scripts -->
      <script src="js/jquery-3.1.1.min.js"></script>
      <script src="js/bootstrap-waitingfor.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.js"></script>
      <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
      <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
      <!-- Custom and plugin javascript -->
      <script src="js/inspinia.js"></script>
      <script src="js/plugins/sweetalert/sweetalert.min.js"></script>
      <script src="js/funciones_generales.js"></script>
      <script>
         const getApi="get_impresion.php";
         const postApi="post_impresion.php";

         function autoComplete(self){
           document.getElementById('Final').value=self.value;
           if(self.value<0 || self.value>999999){
             mensajeError('El folio es incorrecto')
             document.getElementById('Final').value=0;
             document.getElementById('Inicial').value=0;
           }
         }

         function cambioTipo(campo){
           if(campo.value==='02'){
             $( "#Final" ).prop( "disabled", true );
           }else{
             $( "#Final" ).prop( "disabled", false );
           }
           revisarTema();
         }

         async function Generar(enca,cuer,opc){
           var encabezado= await ObtenerDatos(enca);
           var enviar=encabezado+'\n';
           var tipo=$('#tipo').val();
           var cuerpo= await ObtenerDatos(cuer);
           var inicio=document.getElementById('Inicial').value;
           var fin=document.getElementById('Final').value;
           if((String(inicio).length>6 || String(fin).length>6) || (inicio<0 || fin<0)){
             mensajeError('Los folios deben de ser menor o igual a 6 digitos y mayores a 0');
             return;
           }
           var copias=document.getElementById('copias').value;
           var fecha=new Date();
           if(opc){
             for (var i = inicio; i <= fin; i++) {
               enviar+=cuerpo.replaceAll('DT2', dateFormato(fecha,'/')).replaceAll('DT1',GenerarEtiqueta(i,tipo)).replaceAll('PQ1','PQ'+copias)+'\n\n';
             }
           }else{
             var aux=cuerpo;
             var cont=0;
             for (var i = inicio; i <= fin; i++) {
               cont++;
               aux=aux.replaceAll(('DT'+cont),GenerarEtiqueta(i,tipo));
               if(cont%8==0 || i==fin){
                 enviar+=aux+'\n';
                 aux=cuerpo;
                 cont=0;
               }
             }
             enviar=enviar.replaceAll('PQ1','PQ'+copias)+'\n';
           }
           enviar+='^XA^ID000.GRF^FS^XZ';
           if(selected_device.name===undefined){
             try {
               var impresoraIP = await conexion("GET",'RestApi/GET/'+getApi,"");
               await conexion("POST", "http://"+impresoraIP ,enviar);
               mensajeSimple('Información enviada a la impresora');
               Registro();
             } catch (e) {
               mensajeError(e);
             }
           }else{
             imprimir(enviar);
           }
         }

         async function ObtenerDatos(campo){
           try {
             var url='impresora/'+campo+'.prn';
             var result = await conexion("GET",url,"");
             return result;
           } catch(error) {
             await mensajeError('Hubo un problema al obtener el encabezado y/o el cuerpo de las etiquetas');
             return null;
           }
         }

         var selected_device;
         function setup(){
         	BrowserPrint.getDefaultDevice("printer", function(device)
         			{
         				selected_device = device;
                 revisarConfig(device);

         			},function(error){
                 if(error==='' && localStorage['aplicacion']!=='no'){
                   var message_alert = $('<p>Se recomienda usar la aplicacion Zebra Printer para tener una mejor experiencia de impresión ¿Quieres descargarla ahora?</p>').dialog({
                     open: function() {
                         $(this).closest(".ui-dialog")
                         .find(".ui-dialog-titlebar-close")
                         .removeClass("ui-dialog-titlebar-close")
                         .html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");
                     },
                     buttons: {
                         "Cancelar": function() {message_alert.dialog('close');},
                         "Descargar":  function() {
                           let link = document.createElement("a");
                           if( /Mac|Macintosh/i.test(navigator.userAgent) ) {
                             link.download = "Instalador.dmg";
                             link.href = "impresora/zebra-browser-print-mac-v131445.dmg";
                           }else if( /Windows/i.test(navigator.userAgent) ) {
                             link.download = "Instalador.exe";
                             link.href = "impresora/zebra-browser-print-windows-v131445.exe";
                           }else if( /Android/i.test(navigator.userAgent) ) {
                             link.download = "Aplicacion.apk";
                             link.href = "impresora/zebra-browser-print-android-v130158.apk";
                           }
                           link.click();
                           message_alert.dialog('close');
                         },
                         "No preguntar de nuevo":  function() {
                             localStorage['aplicacion']='no';
                             message_alert.dialog('close');
                         }
                     },
                     minWidth: 600,

                   });
                 }
         			})
         }

         async function Registro(){
           var tipo=$('#tipo').val();
           var inicio=document.getElementById('Inicial').value;
           var fin=document.getElementById('Final').value;
           try {
             for (var i = inicio; i <= fin; i++) {
               var params='etiqueta='+GenerarEtiqueta(i,tipo);
               var result=await conexion("POST", 'RestApi/POST/'+postApi,params);
             }
           } catch (e) {
             mensajeError(e);
           }

         }
         function imprimir(dataToWrite){
         	 selected_device.send(dataToWrite, undefined, errorCallback);
           console.log(dataToWrite);
           progress();
           selected_device.isPrinterReady().then(function(){
             Registro();
             return selected_device.send(dataToWrite, undefined, errorCallback);
           }).catch(function(error){
             mensajeError(error);
           })
         }


         function progress(){
           waitingDialog.show('Cargando...');
          waitingDialog.progress(0);
          setTimeout(function(){
             waitingDialog.progress(10);
              waitingDialog.message('Comunicando con la impresora');
              $('.modal-body').append('<div class="col-md-12 text-center  d-flex justify-content-center" ><button class="button5 btn btn-primary b-r-xl" onclick="waitingDialog.hide();">Hacer en segundo plano</button></div>');
          },500);
         var mocks=[{message:'Obteniendo estado de la impresora',prog:10},{message:'Enviando datos a la impresora',prog:30},{message:'Guardando registro en la base de datos',prog:40},{message:'Imprimiendo',prog:50},{prog:55},{prog:70},{prog:80},{message:'Terminando...',prog:95},{prog:96},{prog:99},{prog:100}];
         mocks.forEach(function(e,i){
              setTimeout(function(){
                 if(e.message){
                    waitingDialog.message(e.message);
                 }else{
                    waitingDialog.message(e.prog+'% ...');
                 }
                  waitingDialog.progress(e.prog);
              },(i+1)*1000);
         });

         setTimeout(function () {

                 waitingDialog.hide();

         }, (mocks.length+0.5)*1000);
         }


         var readCallback = function(readData) {
         	if(readData === undefined || readData === null || readData === "")
         	{
         		mensajeError("La impresora no está disponible");
         	}
         	else
         	{
         		mensajeSimple(readData);
         	}

         }
         var errorCallback = function(errorMessage){
         	mensajeError("Error: " + errorMessage);
          waitingDialog.hide();
         }
         function readFromSelectedPrinter()
         {

         	selected_device.read(readCallback, errorCallback);

         }
         var impresoraIP;
         async function revisarConfig(impresora){
           if(impresora.name===undefined){
             mensajeError("Debes de configurar la aplicación de Zebra Printer con una impresora por default");
             return;
           }
           var impresoraIP = await conexion("GET",'RestApi/GET/'+getApi,"");
           if(!impresoraIP.includes(impresora.uid.substring(0,impresora.uid.indexOf(':')))){
             mensajeError("Tu configuración de la aplicación Zebra Printer es incorrecta, llama al administrador y mencionale que asigne esta dirección: "+impresoraIP.substring(0,impresoraIP.indexOf('/')));
             return;
           }
         }

         $(document).ready(function(){
           permisos(["5"]);
           setup();
           document.getElementById('copias').value=1;

         });
      </script>
   </body>
</html>
