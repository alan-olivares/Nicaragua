<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Ajuste de inventario</title>
      <link href="css/jquery.dataTables.min.css" rel="stylesheet">
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
      <link rel="icon" href="img\TBRE.ico">
      <link rel="stylesheet" href="css/jquery-ui.css">
      <link href="css/animate.css" rel="stylesheet">
      <link href="css/style.css" rel="stylesheet">
      <link rel="stylesheet" href="/resources/demos/style.css">
      <link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
      <link href="css/plugins/ladda/ladda-themeless.min.css" rel="stylesheet">
   </head>
   <body>
      <script src="js/revisar_sesion.js"></script>
      <div id="wrapper">
         <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="sidebar-collapse">
               <ul class="nav metismenu" id="side-menu">
                  <li class="nav-header">
                     <div class="dropdown profile-element">
                        <img alt="image" class="rounded-circle perfil" id="perfil1"/>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                           <span class="block m-t-xs font-bold">
                              <script>
                                 document.write(localStorage['nombre'] || 'Sin nombre');
                                 var foto=localStorage['nombre'] || 'Sin nombre';
                                 foto=foto.charAt(0).concat(".png").toLowerCase();
                                 document.getElementById("perfil1").src="img/letras/"+foto;
                              </script>
                           </span>
                           <span class="text-muted text-xs block">
                              <script>
                                 document.write(localStorage['perfil'] || 'Sin perfil');
                              </script><b class="caret"></b>
                           </span>
                        </a>
                        <ul class="dropdown-menu animated fadeInRight m-t-xs">
                           <li><a class="dropdown-item" href="perfil.html">Perfil</a></li>
                           <li class="dropdown-divider"></li>
                           <li><a class="dropdown-item" onclick="limpiar();">Cerrar sesión</a></li>
                        </ul>
                     </div>
                     <div class="logo-element">
                        TBRE
                     </div>
                  </li>
                  <li class="once">
                     <a href="/"><i class="fa fa-area-chart"></i> <span class="nav-label">Operación del día</span></a>
                  </li>
                  <li class="diez">
                     <a href="#"><i class="fa fa-table"></i> <span class="nav-label">Reportes</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                       <li><a href="inventario.html">Inventario</a></li>
                       <li><a href="barriles_plantel.html">Barriles en plantel</a></li>
                       <li><a href="tanques_plantel.html">Tanques en plantel</a></li>
                       <li><a href="llenados.html">Barriles llenados</a></li>
                       <li><a href="rellenados.html">Barriles rellenados</a></li>
                       <li><a href="trasiego.html">Barriles trasegados</a></li>
                       <li><a href="trasiegoHoover.html">T. Hoover llenados</a></li>
                       <li><a href="RGerencia.html">Reporte de Gerencia</a></li>
                     </ul>
                  </li>
                  <li class="dos">
                     <a href="#"><i class="fa fa-desktop"></i> <span class="nav-label">Validar información</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li><a href="VI_barriles.php">Barriles</a></li>
                        <li><a href="VI_hoover.php">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="cinco">
                     <a href="impresion.html"><i class="fa fa-print"></i> <span class="nav-label">Impresión de etiquetas</span></a>
                  </li>
                  <li class="seis">
                     <a href="#"><i class="fa fa-briefcase"></i> <span class="nav-label">Órdenes de trabajo</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                       <li>
                           <a href="#">Llenado<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="OLlenado.html">Orden Llenado</a></li>
                               <li><a href="RLlenadoLlenada.html">Reporte de Llenado</a></li>
                               <li><a href="RLlenadoMantenimineto.html">Reporte de Mantenimiento</a></li>
                               <li><a href="RLlenadoRevisado.html">Reporte de Revisado</a></li>
                           </ul>
                       </li>
                       <li>
                           <a href="#">Relleno<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="ORelleno.html">Orden Relleno</a></li>
                               <li><a href="RRellenoOperacion.html">Reporte de Operación</a></li>
                           </ul>
                       </li>
                       <li><a href="revision.html">Revisión</a></li>
                       <li>
                           <a href="#">Trasiego<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                                <li><a href="OTrasiego.html">Orden Trasiego</a></li>
                                <li><a href="RTrasiegoHojaAnalisis.html">Hoja de Análisis de Trasiego</a></li>
                                <li><a href="RTrasiegoVaciados.html">Barriles vaciados por trasiego</a></li>
                                <li><a href="RTrasiegoRemision.html">Remisión blending</a></li>
                           </ul>
                       </li>
                       <li><a href="OTrasiegoHoover.html">Trasiego Hoover</a></li>
                     </ul>
                  </li>
                  <li class="ocho">
                     <a href="#"><i class="fa fa-inbox"></i> <span class="nav-label">Recepción</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level collapse">
                        <li><a href="RAlcohol.html">Alcohol</a></li>
                        <li><a href="RBarriles.html">Barriles</a></li>
                        <li><a href="RTanquesHoover.html">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="uno-dos">
                     <a href="#"><i class="fa fa-bell"></i> <span class="nav-label">Solicitudes</span><span class="fa arrow"></span><span class="label label-primary float-right uno" style="margin-right:15px;"id="letrero1">0</span></a>
                     <ul class="nav nav-second-level collapse">
                        <li><a href="pendientes.html">Pendientes <span class="label label-primary float-right uno" id="letrero2">0</span></a></li>
                        <li><a href="aceptadas.html">Aceptadas</a></li>
                        <li><a href="rechazadas.html">Rechazadas</a></li>
                        <li><a href="canceladas.html">Canceladas</a></li>
                     </ul>
                  </li>
                  <li class="siete">
                     <a href="disenoAlmacen.html"><i class="fa fa-building"></i> <span class="nav-label">Diseñar almacenes</span></a>
                  </li>
                  <li class="nueve active">
                    <a href="#"><i class="fa fa-edit"></i> <span class="nav-label">Ajustes de inventario</span><span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level collapse">
                       <li><a href="AjustesInventario.html">Inventario</a></li>
                       <li class="active"><a href="AjustesLlenado.html">Llenado</a></li>
                       <li><a href="AjustesRelleno.html">Relleno</a></li>
                    </ul>
                  </li>
                  <li class="tres-cuatro">
                     <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Administración</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li class="tres"><a href="usuarios.html">Usuarios</a></li>
                        <li class="cuatro"><a href="configuracion.html">Configuración</a></li>
                     </ul>
                  </li>
               </ul>
            </div>
         </nav>
         <div id="page-wrapper" class="gray-bg">
            <div class="row border-bottom">
               <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                  <div class="navbar-header">
                     <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
                  </div>
                  <h2 class="nav navbar-top-links titulo welcome-message">Ajustes de inventario para llenado</h2>
                  <ul class="nav navbar-top-links navbar-right">
                     <li class="dropdown uno">
                        <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                        <i class="fa fa-bell"></i>  <span class="label label-primary" id="letrero3">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-alerts">
                           <li>
                              <a href="pendientes.html" class="dropdown-item">
                                 <div id="letrero4">
                                    <i class="fa fa-envelope fa-fw" ></i> Tienes 0 solicitudes de cambios
                                 </div>
                              </a>
                           </li>
                        </ul>
                     </li>
                     <li>
                        <a onclick="javascript:limpiar();">
                        <i class="fa fa-sign-out"></i> Cerrar sesión
                        </a>
                     </li>
                  </ul>
               </nav>
            </div>
            <div class="row wrapper border-bottom white-bg page-heading">
              <div class="col-md-12 text-center  d-flex" >
                 <div class="form-inline text-center d-flex justify-content-center col-md-10"  >
                   <h5>
                      <label id="fechaLab">  Fecha llenado:   </label>
                      <input type="date" class="form-control b-r-xl" id="llenadoDate" onkeydown="return false">
                   </h5>
                    <h5>
                       <label>  Alcohol:  </label>
                       <select class="form-control b-r-xl" id="alcohol">
                         <option value="">Todos</option>
                       </select>
                    </h5>
                    <h5><label>  Uso:   </label>
                       <select class="form-control b-r-xl" id="uso" >
                         <option value="">Todos</option>
                       </select>
                    </h5>
                    <button class="ladda-button btn btn-primary b-r-xl" style="margin-top: 21px;" onclick="CargarTabla();" id="cargando" data-style="zoom-in"><span class="glyphicon glyphicon-search"></span></button>
                 </div>
              </div>
               <div class="col-md-10 d-flex justify-content-center table-responsive text-center " id="table-wrapper" >
                  <div class="table-responsive col-md-12 centro scrollingtable animated" id="scrollingtable">
                     <table class="table table-bordered table-hover" id="barriles">
                        <thead>
                        </thead>
                        <tbody></tbody>
                     </table>
                  </div>
               </div>
               <div class="col-md-2 justify-content-center text-center">
                 <div class="col-md-12" >
                   <label>  Nuevo uso:   </label>
                   <select class="form-control b-r-xl" id="uso2" disabled>
                   </select>
                 </div>
                 <div class="col-md-12" >
                   <label id="tipoLab">  Barriles:   </label>
                   <input class="touchspin" type="text"  id="barrilesC" onchange="cambioBarriles(this);" disabled>
                 </div>
                 <div class="col-md-12">
                    <h5>
                       <label>  Motivo:   </label>
                       <select class="form-control b-r-xl" required="true" id="motivo" disabled>
                       </select>
                    </h5>
                 </div>
                 <div class="col-md-12 row justify-content-center">
                   <button class="button2 btn btn-primary b-r-xl" onclick="solicitarCambios()" id="solicitar" disabled>Solicitar</button>
                   <button class="button5 btn btn-primary b-r-xl" onclick="borrarSeleccion()" id="quitar" disabled>Quitar seleccionados</button>
                 </div>
               </div>
               <div class="sk-spinner sk-spinner-three-bounce">
                  <div class="sk-bounce1"></div>
                  <div class="sk-bounce2"></div>
                  <div class="sk-bounce3"></div>
               </div>
            </div>
            <div class="footer">
               <div>
                  <strong>Todos los derechos reservados | </strong>SER Licorera 2014
               </div>
            </div>

         </div>
      </div>
      <!-- Mainly scripts -->
      <script src="js/jquery-3.1.1.min.js"></script>
      <script src="js/jquery-ui.js"></script>
      <script src="js/jquery.dataTables.min.js"></script>
      <script src="js/plugins/dataTables/datatables.min.js"></script>
      <script src="js/plugins/dataTables/dataTables.bootstrap4.min.js"></script>
      <script src="js/json2html.min.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.js"></script>
      <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
      <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
      <script src="js/plugins/ladda/spin.min.js"></script>
      <script src="js/plugins/ladda/ladda.min.js"></script>
      <script src="js/plugins/ladda/ladda.jquery.min.js"></script>
      <!-- Custom and plugin javascript -->
      <script src="js/inspinia.js"></script>
      <script src="js/plugins/pace/pace.min.js"></script>
      <script src="js/funciones_generales.js"></script>
      <script src="js/plugins/sweetalert/sweetalert.min.js"></script>
      <!-- TouchSpin -->
      <script src="js/plugins/touchspin/jquery.bootstrap-touchspin.min.js"></script>
      <script src="js/plugins/datapicker/bootstrap-datepicker.js"></script>

      <script>
         const getApi="get_ajustesInventario.php";
         const postApi="post_ajustesInventario.php";

         function cambioBarriles(campo){
           if(campo.value<=$('#barriles tbody tr').length){
             $('#barriles > tbody > tr').removeClass('selected');
             $('#barriles > tbody > tr:lt('+(campo.value)+')').addClass('selected');
             $('#barriles > tbody > tr').children('td').removeClass('seleccionado');
             $('#barriles > tbody > tr:lt('+(campo.value)+')').children('td').addClass('seleccionado');
             cambiarEstado();
           }else{
             campo.value=$('#barriles > tbody > tr').length;
             mensajeError('La cantidad es mayor a la cantidad de barriles disponibles en la busqueda');
           }
         }


         function lengthSelec(){
           var elements = document.getElementsByClassName("selected");
           return elements.length;
         }

         function cambiarEstado(){
           var check=lengthSelec()==0;
           $('#uso2').attr("disabled", check);
           $('#motivo').attr("disabled", check);
           $('#solicitar').attr("disabled", check);
           $('#quitar').attr("disabled", check);
           revisarTema();
         }
         function borrarSeleccion(){
           $(".selected").removeClass("selected");
           $(".seleccionado").removeClass("seleccionado");
           cambiarEstado();
         }

         async function solicitarCambios(estado){
           var elements = document.getElementsByClassName("selected");
           if($('#motivo').val()===''){
             await mensajeError('El motivo no debe estar vacío');
             return;
           }
           if(elements.length>0){
             if(await mensajeOpcional('Se modificarán '+lengthSelec()+' barril(es) dandoles el uso '+$('#uso2 :selected').text()+' ¿Deseas continuar?')){
               empezar();
               try {
                 var consecutivos=[];
                 $( ".selected" ).each(function() {
                   var orden=$( this ).children('td:first').text();
                   var consecutivo=EtiquetaAConsecutivo($( this ).children('td:nth-child(2)').text());
                   var litros=$( this ).children('td:nth-child(5)').find("input").val();
                   consecutivos.push({Orden: orden, Consecutivo: consecutivo, Litros: litros});//Se obtienen los valores de la primera posicion creando un arreglo de consecutivos
                 });
                 var url='RestApi/POST/'+postApi;
                 var params='motivo='+$('#motivo').val()+'&jsonLlenado='+JSON.stringify(consecutivos)+"&uso="+$('#uso2').val();
                 var result=await conexion("POST", url,params);
                 setTimeout(function() {
                   mensajeSimple(result+'\n Nota: Los registros se actualizan, pero los nuevos datos del barril deben ser aceptados en las solicitudes pendientes');
                 }, 500);
                 ObtenerNotificaciones();
                 CargarTabla();
               }catch(error){
                 mensajeError(error)
               }finally{
                 parar();
               }
             }
           }else{
             await mensajeError('Selecciona al menos un barril')
           }

         }
         async function CargarTabla(){
           try {
             if($('#llenadoDate').val()===''){
               alert('La fecha no debe de estár vacía');
               return;
             }
             var l = $('#cargando').ladda();
             l.ladda('start');
             const url='RestApi/GET/'+getApi+'?llenado=true&fecha='+$('#llenadoDate').val()+'&alcohol='+$('#alcohol').val()+"&uso="+$('#uso').val();
             var result = await conexion("GET",url,"");
             var parsed =JSON.parse(result);
             if(table!=null){
               table.destroy();
             }
             if(parsed.length>10000){
               if(await mensajeOpcional('Se encontraron '+parsed.length+' resultados, lo que provocará que tome hasta varios minutos en cargar ¿Deseas continuar?')){
                 setTimeout(function() {recargarTabla(parsed,l);}, 500);
               }
             }else{
               recargarTabla(parsed,l);
             }
           } catch(error) {
             mensajeError(error);
           }finally{
             l.ladda('stop');
           }

         }
         function recargarTabla(parsed){
           crearTablaJson(parsed,"#barriles");
           $('#barrilesC').attr("disabled", false);
           $('#barriles').show();
           table = $('#barriles').DataTable({
             responsive: true,
             "bPaginate": (parsed.length>100),
             "paging":   (parsed.length>100),
             "ordering": true,
             "info":     false,
             "lengthMenu": [ 100, 200, 300, 500],
             searching: (parsed.length>100),
             "language": {
               "lengthMenu":     "Mostrar _MENU_ resultados",
               "emptyTable": "No hay barriles con la busqueda seleccionada",
               searchPlaceholder: "Busca algún dato aquí",
               search: "",
               "paginate": {
                 "first":      "Primera",
                 "last":       "Última",
                 "next":       "Siguiente",
                 "previous":   "Anterior"
               },
             }
           });
           cambiarEstado();
         }
         var table=null;

         async function cargarSelects(boton,tipo,id,descripcion){
           try {
             var url='RestApi/GET/'+getApi+'?'+tipo+'=true';
             var result = await conexion("GET",url,"");
             var parsed =JSON.parse(result);
             llenarSelect('#'+boton,id,descripcion,parsed);
           } catch (e) {
             mensajeError(e);
           }
         }

         function toggleInput(row){
           if(row.hasClass( "selected" )){
             td = row.find("td:nth-child(5)");
             td.wrapInner('<input class="form-control" type="number" value = ' + td.text() + '></input>');
           }else{
             td = row.find("td:nth-child(5)");
             input=td.find("input");
             td.text(input.val());
             input.remove();
           }
         }

         $(document).ready(function(){
           $('#tipo').val('1');
           $("#barriles").hide();
           permisos(["9"]);
           cargarSelects('annio','annio','annio','annio');
           cargarSelects('alcohol','alcohol','IdAlcohol','Descripcion');
           cargarSelects('uso','uso','IdCodificacion','Codigo');
           cargarSelects('uso2','uso','IdCodificacion','Codigo');
           cargarSelects('motivo','motivo','IdRazon','Descripcion');
           //CargarTabla();

           $('#barriles tbody').on( 'click', 'tr', function (e) {
             var row = $(this).closest('tr');
             if ($(e.target).closest('td').is(':nth-child(5)') && row.find("td:nth-child(5)").find("input").val()) {
               return;
             }
             row.toggleClass('selected');
             row.children('td').toggleClass('seleccionado');
             toggleInput(row);
             cambiarEstado();
           });
           $(".touchspin").TouchSpin({
               min: 0,
               max: 1000,
               step: 1,
               boostat: 5,
               maxboostedstep: 10,
               buttondown_class: 'btn btn-white',
               buttonup_class: 'btn btn-white'
           });
           document.getElementById("llenadoDate").valueAsDate= new Date();
         });
      </script>
   </body>
</html>
