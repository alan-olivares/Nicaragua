<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Solicitudes</title>
      <link href="css/jquery.dataTables.min.css" rel="stylesheet">
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
      <link rel="icon" href="img\TBRE.ico">
      <link rel="stylesheet" href="css/jquery-ui.css">
      <link href="css/animate.css" rel="stylesheet">
      <link href="css/style.css" rel="stylesheet">
      <link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
   </head>
   <body>
      <script src="js/revisar_sesion.js"></script>
      <div id="wrapper">
         <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="sidebar-collapse">
               <ul class="nav metismenu" id="side-menu">
                  <li class="nav-header">
                     <div class="dropdown profile-element">
                        <img alt="image" class="rounded-circle perfil" id="perfil1"/>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                           <span class="block m-t-xs font-bold">
                              <script>
                                 document.write(localStorage['nombre'] || 'Sin nombre');
                                 var foto=localStorage['nombre'] || 'Sin nombre';
                                 foto=foto.charAt(0).concat(".png").toLowerCase();
                                 document.getElementById("perfil1").src="img/letras/"+foto;
                              </script>
                           </span>
                           <span class="text-muted text-xs block">
                              <script>
                                 document.write(localStorage['perfil'] || 'Sin perfil');
                              </script><b class="caret"></b>
                           </span>
                        </a>
                        <ul class="dropdown-menu animated fadeInRight m-t-xs">
                           <li><a class="dropdown-item" href="perfil.html">Perfil</a></li>
                           <li class="dropdown-divider"></li>
                           <li><a class="dropdown-item" onclick="limpiar();">Cerrar sesión</a></li>
                        </ul>
                     </div>
                     <div class="logo-element">
                        TBRE
                     </div>
                  </li>
                  <li class="once">
                     <a href="index.html"><i class="fa fa-area-chart"></i> <span class="nav-label">Operación del día</span></a>
                  </li>
                  <li class="diez">
                     <a href="#"><i class="fa fa-table"></i> <span class="nav-label">Reportes</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                       <li><a href="inventario.html">Inventario</a></li>
                       <li><a href="barriles_plantel.html">Barriles en plantel</a></li>
                       <li><a href="tanques_plantel.html">Tanques en plantel</a></li>
                       <li><a href="llenados.html">Barriles llenados</a></li>
                       <li><a href="rellenados.html">Barriles rellenados</a></li>
                       <li><a href="trasiego.html">Barriles trasegados</a></li>
                       <li><a href="trasiegoHoover.html">T. Hoover llenados</a></li>
                       <li><a href="RGerencia.html">Reporte de Gerencia</a></li>
                     </ul>
                  </li>
                  <li class="dos">
                     <a href="#"><i class="fa fa-desktop"></i> <span class="nav-label">Validar información</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li><a href="VI_barriles.php">Barriles</a></li>
                        <li><a href="VI_hoover.php">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="cinco">
                     <a href="impresion.html"><i class="fa fa-print"></i> <span class="nav-label">Impresión de etiquetas</span></a>
                  </li>
                  <li class="seis">
                     <a href="#"><i class="fa fa-briefcase"></i> <span class="nav-label">Ordenes de trabajo</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                       <li>
                           <a href="#">Llenado<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="OLlenado.html">Orden Llenado</a></li>
                               <li><a href="RLlenadoLlenada.html">Reporte de Llenado</a></li>
                               <li><a href="RLlenadoMantenimineto.html">Reporte de Mantenimiento</a></li>
                               <li><a href="RLlenadoRevisado.html">Reporte de Revisado</a></li>
                           </ul>
                       </li>
                       <li>
                           <a href="#">Relleno<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="ORelleno.html">Orden Relleno</a></li>
                               <li><a href="RRellenoOperacion.html">Reporte de Operación</a></li>
                           </ul>
                       </li>
                       <li><a href="revision.html">Revisión</a></li>
                       <li>
                           <a href="#">Trasiego<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                                <li><a href="OTrasiego.html">Orden Trasiego</a></li>
                                <li><a href="RTrasiegoHojaAnalisis.html">Hoja de Análisis de Trasiego</a></li>
                                <li><a href="RTrasiegoVaciados.html">Barriles vaciados por trasiego</a></li>
                                <li><a href="RTrasiegoRemision.html">Remisión blending</a></li>
                           </ul>
                       </li>
                       <li><a href="OTrasiegoHoover.html">Trasiego Hoover</a></li>
                     </ul>
                  </li>
                  <li class="ocho">
                     <a href="#"><i class="fa fa-inbox"></i> <span class="nav-label">Recepción</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level collapse">
                        <li><a href="RAlcohol.html">Alcohol</a></li>
                        <li><a href="RBarriles.html">Barriles</a></li>
                        <li><a href="RTanquesHoover.html">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="active uno-dos">
                     <a href="#"><i class="fa fa-bell"></i> <span class="nav-label">Solicitudes</span><span class="fa arrow"></span><span class="label label-primary float-right uno" style="margin-right:15px;"id="letrero1">0</span></a>
                     <ul class="nav nav-second-level collapse">
                        <li class="active"><a href="pendientes.html">Pendientes <span class="label label-primary float-right uno" id="letrero2">0</span></a></li>
                        <li><a href="aceptadas.html">Aceptadas</a></li>
                        <li><a href="rechazadas.html">Rechazadas</a></li>
                        <li><a href="canceladas.html">Canceladas</a></li>
                     </ul>
                  </li>
                  <li class="siete">
                     <a href="disenoAlmacen.html"><i class="fa fa-building"></i> <span class="nav-label">Diseñar almacenes</span></a>
                  </li>
                  <li class="nueve">
                     <a href="AjustesInventario.html"><i class="fa fa-edit"></i> <span class="nav-label">Ajustes de inventario</span></a>
                  </li>
                  <li class="tres-cuatro">
                     <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Administración</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li class="tres"><a href="usuarios.html">Usuarios</a></li>
                        <li class="cuatro"><a href="configuracion.html">Configuración</a></li>
                     </ul>
                  </li>
               </ul>
            </div>
         </nav>
         <div id="page-wrapper" class="gray-bg">
            <div class="row border-bottom">
               <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                  <div class="navbar-header">
                     <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
                  </div>
                  <h2 class="nav navbar-top-links titulo welcome-message">Solicitudes pendientes</h2>
                  <ul class="nav navbar-top-links navbar-right">
                     <li class="dropdown uno">
                        <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                        <i class="fa fa-bell"></i>  <span class="label label-primary" id="letrero3">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-alerts">
                           <li>
                              <a href="pendientes.html" class="dropdown-item">
                                 <div id="letrero4">
                                    <i class="fa fa-envelope fa-fw" ></i> Tienes 0 solicitudes de cambios
                                 </div>
                              </a>
                           </li>
                        </ul>
                     </li>
                     <li>
                        <a onclick="javascript:limpiar();">
                        <i class="fa fa-sign-out"></i> Cerrar sesión
                        </a>
                     </li>
                  </ul>
               </nav>
            </div>
            <div class="row wrapper border-bottom white-bg page-heading">
              <div class="col-md-12 text-center  d-flex justify-content-center" style="margin-top:20px;">
                 <select class="col-md-3 b-r-xl form-control" id="tipo" onchange="CargarTabla(this.value);">
                   <option value="1">Barriles</option>
                   <option value="2">Tanques Hoover</option>
                 </select>
              </div>
               <div class="col-md-12 text-center  d-flex justify-content-center" >
                  <div class="form-inline text-center d-flex justify-content-center"  >
                     <button class="button5 btn btn-w-m btn-danger autorizador b-r-xl todas" onclick="HacerTodas(3);" >Rechazar todos</button>
                     <button class="button5 btn btn-w-m btn-danger autorizador b-r-xl todas" onclick="HacerTodas(2);">Aceptar todos</button>
                     <button class="button5 btn btn-primary autorizador b-r-xl seleccion" onclick="Cambios(3);">Rechazar seleccionados</button>
                     <button class="button5 btn btn-primary autorizador b-r-xl seleccion" onclick="Cambios(2);">Aceptar seleccionados</button>
                     <button class="button5 btn btn-w-m btn-danger Nautorizador b-r-xl todas" onclick="HacerTodas(3);">Cancelar todos</button>
                     <button class="button5 btn btn-primary Nautorizador b-r-xl seleccion" onclick="Cambios(3);">Cancelar seleccionados</button>
                  </div>
               </div>
               <div class="col-md-12 d-flex justify-content-center table-responsive text-center ">
                  <div class="table-responsive col-md-12 centro">
                     <table class="table table-bordered" id="barriles">
                        <thead>
                        </thead>
                        <tbody></tbody>
                     </table>
                  </div>
               </div>
               <div class="sk-spinner sk-spinner-three-bounce">
                  <div class="sk-bounce1"></div>
                  <div class="sk-bounce2"></div>
                  <div class="sk-bounce3"></div>
               </div>
            </div>
            <div class="footer">
               <div>
                  <strong>Todos los derechos reservados | </strong>SER Licorera 2014
               </div>
            </div>
            <div id="Dialog" title="Descripción" class="animated">
               <div>
                  <div class="col-md-12 text-center  d-flex justify-content-center" >
                     <div class="table-responsive col-md-12 centro" >
                        <caption>Versión actual</caption>
                        <table class="table table-bordered table-hover display"  id="viejoBarril">
                           <thead></thead>
                           <tbody></tbody>
                        </table>
                     </div>
                  </div>
                  <div class="sk-spinner sk-spinner-three-bounce">
                     <div class="sk-bounce1"></div>
                     <div class="sk-bounce2"></div>
                     <div class="sk-bounce3"></div>
                  </div>
                  <div class="col-md-12 text-center  d-flex justify-content-center" >
                     <div class="table-responsive col-md-12 centro" >
                        <caption>Versión a confirmar</caption>
                        <table class="table table-bordered table-hover display"  id="nuevoBarril">
                           <thead></thead>
                           <tbody></tbody>
                        </table>
                     </div>
                  </div>
                  <div class="col-md-12 text-center  d-flex justify-content-center" >
                     <button class="button5 btn btn-primary cerrar">Cerrar</button>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- Mainly scripts -->
      <script src="js/jquery-3.1.1.min.js"></script>
      <script src="js/jquery-ui.js"></script>
      <script src="js/jquery.dataTables.min.js"></script>
      <script src="js/plugins/dataTables/datatables.min.js"></script>
      <script src="js/plugins/dataTables/dataTables.bootstrap4.min.js"></script>
      <script src="js/json2html.min.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.js"></script>
      <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
      <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
      <script src="js/inspinia.js"></script>
      <script src="js/plugins/pace/pace.min.js"></script>
      <script src="js/funciones_generales.js"></script>
      <script src="js/plugins/sweetalert/sweetalert.min.js"></script>
      <script>
         const getApi="get_solicitudes.php";
         const postApi="post_solicitudes.php";
         $( function() {
           var options={
             open: function() {
                 $(this).closest(".ui-dialog")
                 .find(".ui-dialog-titlebar-close")
                 .removeClass("ui-dialog-titlebar-close").addClass("b-r-xl btn btn-danger");
             },
             autoOpen: false,
             height: 'auto',
             width: 'auto',
             modal: true,
             closeOnEscape: true,
             position:{ my: "center", at: "center top", of: '#barriles' },
             show: {
               effect: "puff",
               duration: 800
             },
             hide: {
               effect: "drop",
               duration: 800
             },
             maxHeight: 570
           };

           Dialog = $( "#Dialog" ).dialog(options);
           $( ".cerrar" ).button().on( "click", function() {
             Dialog.dialog( "close" );
         });


         } );


         async function CargarDialogo(idAjuste){
           try {
             var url='RestApi/GET/'+getApi+'?idAjuste='+idAjuste+"&opc=1&tipo="+$('#tipo').val();
             var result = await conexion("GET",url,"");
             var parsed =JSON.parse(result);
             crearTablaJson(parsed,'#viejoBarril');
             url='RestApi/GET/'+getApi+'?idAjuste='+idAjuste+"&opc=2&tipo="+$('#tipo').val();
             result = await conexion("GET",url,"");
             parsed =JSON.parse(result);
             crearTablaJson(parsed,'#nuevoBarril');
           } catch(error) {
             await mensajeError(error);
           }
           Dialog.dialog( "open" );
         }

         async function HacerTodas(estado){
           var op="rechazar";
           if(estado==2){
             op="aceptar";
           }
           var ids=[];
           $( "#barriles tbody tr" ).each(function() {
             var value=$( this ).children('td:first').text();
             try {
               ids.push(parseInt(value));//Se obtienen los valores de la primera posicion creando un arreglo de ids
             } catch (e) {}
           });
           if(ids.length==0){
             await mensajeError('No hay solicitudes para '+op);
           }else if(await mensajeOpcional('¿Estas seguro de que quieres '+op+' todas las solicitudes?')){
             EnviarDatos(ids,estado);
           }
         }

         async function EnviarDatos(ids,estado){
           empezar();
           try {
             var params='ids='+ids+'&estado='+estado+"&tipo="+$('#tipo').val();
             var url='RestApi/POST/'+postApi;
             var result=await conexion("POST",url,params);
             setTimeout(async function() {
               mensajeSimple(result);
               CargarTabla($('#tipo').val());
               ObtenerNotificaciones();
             }, 500);
           }catch(error){
             setTimeout(async function() {
               mensajeError(error);
             }, 500);
           }finally{
             parar();
           }
         }


         async function Cambios(estado){
           var op="rechazar";
           if(estado==2){
             op="aceptar";
           }
           var ids=[];
           $( ".selected" ).each(function() {
             ids.push($( this ).children('td:first').text());//Se obtienen los valores de la primera posicion creando un arreglo de ids
           });
           if(ids.length==0){
              mensajeError('Selecciona al menos una solicitud');
              return;
           }

           if(await mensajeOpcional('¿Estas seguro de que quieres '+op+' estos cambios?')){
             EnviarDatos(ids,estado);
           }
         }

         async function CargarTabla(valor){
           try {
             empezar();
             if(table!=null){
               table.destroy();
             }
             $('#barriles > tbody').empty();
             $('#barriles > thead').empty();
             cambiarEstado();
             var url='RestApi/GET/'+getApi+'?tipo='+valor+'&estado=1';
             var result = await conexion("GET",url,"");
             var parsed =JSON.parse(result);
             $('.todas').attr("disabled", parsed.length==0);
             var content="";
             if(valor==='1'){
               content="<tr><th>ID Solicitud</th><th>Evento</th><th>Consecutivo</th><th>Fecha de solicitud</th><th>Solicitante</th><th>Estado</th><th>Motivo</th><th>Detalles</th></tr>";
               var transform = {"tag":"table", "children":[
                 {"tag":"tbody","children":[
                   {"tag":"tr","children":[
                     {"tag":"td","html":"${IdAjuste}"},
                     {"tag":"td","html":"${Evento}"},
                     {"tag":"td","html":"${Consecutivo}"},
                     {"tag":"td","html":"${FechaSolicitud}"},
                     {"tag":"td","html":"${Solicitante}"},
                     {"tag":"td","html":"${Estado}"},
                     {"tag":"td","html":"${Descripcion}"},
                     {"tag":"td","html":'<button class=" btn btn-primary b-r-xl" onclick="preparDialogo(this);">Ver</button>'},
                   ]}
                 ]}
               ]};
             }else if(valor==='2'){
               content="<tr><th>ID Solicitud</th><th>Evento</th><th>NoSerie</th><th>Fecha de solicitud</th><th>Solicitante</th><th>Estado</th><th>Motivo</th><th>Detalles</th></tr>";
               var transform = {"tag":"table", "children":[
                 {"tag":"tbody","children":[
                   {"tag":"tr","children":[
                     {"tag":"td","html":"${IdAjuste}"},
                     {"tag":"td","html":"${Evento}"},
                     {"tag":"td","html":"${NoSerie}"},
                     {"tag":"td","html":"${FechaSolicitud}"},
                     {"tag":"td","html":"${Solicitante}"},
                     {"tag":"td","html":"${Estado}"},
                     {"tag":"td","html":"${Descripcion}"},
                     {"tag":"td","html":'<button class=" btn btn-primary b-r-xl"  onclick="preparDialogo(this);">Ver</button>'},
                   ]}
                 ]}
               ]};
             }
             $('#barriles > thead').append(content);
             $('#barriles > tbody').html(json2html.transform(parsed,transform));
             parar();
           } catch(error) {
             await mensajeError(error);
           }
           Recargar();
         }
         function preparDialogo(campo){
           var $row = $(campo).closest('tr');
           CargarDialogo($row.children('td:first').text());
         }

         var table=null;

         function Recargar(){
           table = $('#barriles').DataTable({
             responsive: false,
             "bPaginate": false,
             "paging":   false,
             "ordering": false,
             "info":     false,
             searching: true,
             "language": {
               "emptyTable": "No se encontraron solicitudes",
               searchPlaceholder: "Busca algún dato aquí",
               search: "",
             }
           });
           //revisarTema();

         }

         async function permisos(){
           var perm=await revisarPermisos(["1","2"]);
           if(!perm){
             if(localStorage['paginaI']!=null){
               window.location.replace(localStorage['paginaI']);
             }else{
               limpiar();
             }
           }
           if(await revisarPermisos(["1"])){
             $(".Nautorizador").hide();
           }else{
             $(".autorizador").hide();
           }
         }
         function cambiarEstado(){
           $('.seleccion').attr("disabled", document.getElementsByClassName("selected").length==0);
         }


         $(document).ready(function(){
           permisos();
           CargarTabla('1');
           $('#barriles tbody').on( 'click', 'tr', function (e) {
             var $row = $(this).closest('tr');
             if( e.target._DT_CellIndex!=undefined) {
               $row.children('td').toggleClass('seleccionado');
               $row.toggleClass('selected');
               cambiarEstado();
             }
           });
         });
      </script>
   </body>
</html>
