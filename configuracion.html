<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>TBRE</title>
      <link href="css/bootstrap.min.css" rel="stylesheet">
      <link href="font-awesome/css/font-awesome.css" rel="stylesheet">
      <link rel="icon" href="img\TBRE.ico">
      <link rel="stylesheet" href="css/jquery-ui.css">
      <link href="css/animate.css" rel="stylesheet">
      <link href="css/style.css" rel="stylesheet">
      <link rel="stylesheet" href="/resources/demos/style.css">
      <link href="css/plugins/sweetalert/sweetalert.css" rel="stylesheet">
   </head>
   <body>
      <script src="js/revisar_sesion.js"></script>
      <div id="wrapper">
         <nav class="navbar-default navbar-static-side" role="navigation">
            <div class="sidebar-collapse">
               <ul class="nav metismenu" id="side-menu">
                  <li class="nav-header">
                     <div class="dropdown profile-element">
                        <img alt="image" class="rounded-circle perfil" id="perfil1"/>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                           <span class="block m-t-xs font-bold">
                              <script>
                                 document.write(localStorage['nombre'] || 'Sin nombre');
                                 var foto=localStorage['nombre'] || 'Sin nombre';
                                 foto=foto.charAt(0).concat(".png").toLowerCase();
                                 document.getElementById("perfil1").src="img/letras/"+foto;
                              </script>
                           </span>
                           <span class="text-muted text-xs block">
                              <script>
                                 document.write(localStorage['perfil'] || 'Sin perfil');
                              </script><b class="caret"></b>
                           </span>
                        </a>
                        <ul class="dropdown-menu animated fadeInRight m-t-xs">
                           <li><a class="dropdown-item" href="perfil.html">Perfil</a></li>
                           <li class="dropdown-divider"></li>
                           <li><a class="dropdown-item" onclick="limpiar();">Cerrar sesión</a></li>
                        </ul>
                     </div>
                     <div class="logo-element">
                        TBRE
                     </div>
                  </li>
                  <li class="once">
                     <a href="index.php"><i class="fa fa-area-chart"></i> <span class="nav-label">Operación del día</span></a>
                  </li>
                  <li class="diez">
                     <a href="#"><i class="fa fa-table"></i> <span class="nav-label">Reportes</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li><a href="inventario.html">Inventario</a></li>
                        <li><a href="barriles_plantel.html">Barriles en plantel</a></li>
                        <li><a href="llenados.html">Barriles llenados</a></li>
                        <li><a href="rellenados.html">Barriles rellenados</a></li>
                        <li><a href="trasiego.html">Barriles trasegados</a></li>
                        <li><a href="RGerencia.html">Reporte de Gerencia</a></li>
                     </ul>
                  </li>
                  <li class="dos">
                     <a href="#"><i class="fa fa-desktop"></i> <span class="nav-label">Validar información</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li><a href="VI_barriles.php">Barriles</a></li>
                        <li><a href="VI_hoover.php">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="cinco">
                     <a href="impresion.html"><i class="fa fa-print"></i> <span class="nav-label">Impresión de etiquetas</span></a>
                  </li>
                  <li class="seis">
                     <a href="#"><i class="fa fa-briefcase"></i> <span class="nav-label">Órdenes de trabajo</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                       <li>
                           <a href="#">Llenado<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="OLlenado.html">Orden Llenado</a></li>
                               <li><a href="RLlenadoLlenada.html">Reporte de Llenado</a></li>
                               <li><a href="RLlenadoMantenimineto.html">Reporte de Mantenimiento</a></li>
                               <li><a href="RLlenadoRevisado.html">Reporte de Revisado</a></li>
                           </ul>
                       </li>
                       <li>
                           <a href="#">Relleno<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                               <li><a href="ORelleno.html">Orden Relleno</a></li>
                               <li><a href="RRellenoOperacion.html">Reporte de Operación</a></li>
                           </ul>
                       </li>
                       <li><a href="revision.html">Revisión</a></li>
                       <li>
                           <a href="#">Trasiego<span class="fa arrow"></span></a>
                           <ul class="nav nav-third-level">
                                <li><a href="OTrasiego.html">Orden Trasiego</a></li>
                                <li><a href="RTrasiegoHojaAnalisis.html">Hoja de Análisis de Trasiego</a></li>
                                <li><a href="RTrasiegoVaciados.html">Barriles vaciados por trasiego</a></li>
                                <li><a href="RTrasiegoRemision.html">Remisión blending</a></li>
                           </ul>
                       </li>
                       <li><a href="OTrasiegoHoover.html">Trasiego Hoover</a></li>
                     </ul>
                  </li>
                  <li class="ocho">
                     <a href="#"><i class="fa fa-inbox"></i> <span class="nav-label">Recepción</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level collapse">
                        <li><a href="RAlcohol.html">Alcohol</a></li>
                        <li><a href="RBarriles.html">Barriles</a></li>
                        <li><a href="RTanquesHoover.html">Tanques Hoover</a></li>
                     </ul>
                  </li>
                  <li class="uno-dos">
                     <a href="#"><i class="fa fa-bell"></i> <span class="nav-label">Solicitudes</span><span class="fa arrow"></span><span class="label label-primary float-right uno" style="margin-right:15px;"id="letrero1">0</span></a>
                     <ul class="nav nav-second-level collapse">
                        <li><a href="pendientes.html">Pendientes <span class="label label-primary float-right uno" id="letrero2">0</span></a></li>
                        <li><a href="aceptadas.html">Aceptadas</a></li>
                        <li><a href="rechazadas.html">Rechazadas</a></li>
                        <li><a href="canceladas.html">Canceladas</a></li>
                     </ul>
                  </li>
                  <li class="siete">
                     <a href="disenoAlmacen.html"><i class="fa fa-building"></i> <span class="nav-label">Diseñar almacenes</span></a>
                  </li>
                  <li class="nueve">
                     <a href="AjustesInventario.html"><i class="fa fa-edit"></i> <span class="nav-label">Ajustes de inventario</span></a>
                  </li>
                  <li class="tres-cuatro active">
                     <a href="#"><i class="fa fa-gear"></i> <span class="nav-label">Administración</span><span class="fa arrow"></span></a>
                     <ul class="nav nav-second-level">
                        <li class="tres"><a href="usuarios.html">Usuarios</a></li>
                        <li class="cuatro active"><a href="configuracion.html">Configuración</a></li>
                     </ul>
                  </li>
               </ul>
            </div>
         </nav>
         <div id="page-wrapper" class="gray-bg">
            <div class="row border-bottom">
               <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
                  <div class="navbar-header">
                     <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#"><i class="fa fa-bars"></i> </a>
                  </div>
                  <h2 class="nav navbar-top-links welcome-message" style="margin-left:90px; margin-right:10px;">Configuración</h2>
                  <ul class="nav navbar-top-links navbar-right">
                     <li class="dropdown uno">
                        <a class="dropdown-toggle count-info" data-toggle="dropdown" href="#">
                        <i class="fa fa-bell"></i>  <span class="label label-primary" id="letrero3">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-alerts">
                           <li>
                              <a href="pendientes.html" class="dropdown-item">
                                 <div id="letrero4">
                                    <i class="fa fa-envelope fa-fw" ></i> Tienes 0 solicitudes de cambios
                                 </div>
                              </a>
                           </li>
                        </ul>
                     </li>
                     <li>
                        <a onclick="javascript:limpiar();">
                        <i class="fa fa-sign-out"></i> Cerrar sesión
                        </a>
                     </li>
                  </ul>
               </nav>
            </div>

            <div class="tabs-container">
              <ul class="nav nav-tabs d-flex justify-content-center" role="tablist">
                 <li><a class="nav-link active" data-toggle="tab" href="#conf">Configuración del sistema</a></li>
                 <li><a class="nav-link" data-toggle="tab" href="#mov">Motivos de movimientos</a></li>
              </ul>
              <div class="tab-content" >
                <div role="tabpanel" id="conf" class="tab-pane active">
                  <div class="row text-center  white-bg text-center d-flex justify-content-center col-md-12">
                    <div id="inputsDinamicos" class="col-md-12">
                    </div>
                    <div class="col-md-12 text-center  d-flex justify-content-center" >
                       <h5><label>  Modificar campos:   </label>
                          <input type="checkbox" onchange='OcultarPass(this);' id="cbox" style="margin-right:40px;">
                       </h5>
                    </div>
                    <div class="col-md-12 text-center  d-flex justify-content-center" >
                       <button class="button5 btn btn-primary b-r-xl" onclick="GuardarDatos();" style="margin-right:70px;">Guardar cambios</button>
                    </div>
                  </div>
                </div>
                <div role="tabpanel" id="mov" class="tab-pane">
                  <div class="row text-center  white-bg text-center d-flex justify-content-center">
                    <div class="row col-md-10 d-flex justify-content-center">
                      <div class="col-md-5" style="margin-top:20px;">
                        <label>Eventos: </label>
                        <select class="form-control" size="5" onchange="CargarRazones(this)" id="eventos">
                          <option value="1">Agregar</option>
                          <option value="2">Editar</option>
                          <option value="3">Mover</option>
                          <option value="4">Ajustes</option>
                        </select>
                      </div>
                      <div class="col-md-5" style="margin-top:20px;">
                        <label>Motivos: </label>
                        <select class="form-control" size="5" id="razones" onchange="$('#del').prop('disabled', false);$('#upd').prop('disabled', false);" >
                        </select>
                      </div>
                    </div>
                    <div class="row col-md-10 d-flex justify-content-center">
                      <div class="d-flex justify-content-center" style="margin-top:20px; margin-bottom:40px;">
                        <button class="button2 btn btn-primary b-r-xl" onclick="prepararDialogo('Agregar')" id="add">Agregar</button>
                        <button class="button2 btn btn-primary b-r-xl" onclick="prepararDialogo('Actualizar')" id="upd">Actualizar</button>
                        <button class="button2 btn btn-danger b-r-xl" onclick="BorrarRazon();" id="del">Borrar</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="motivoTarea" title="Motivos" class="animated">
               <div class="col-md-12 text-center  d-flex justify-content-center" >
                  <div class="col-md-10 text-center " >
                     <h5><label id="mensaje"></label>
                        <input style="margin-top:20px;" type="text" class="form-control"  id="razonNueva" onchange="TextoCambio(this);">
                     </h5>
                  </div>
               </div>
               <div class="col-md-12 text-center" >
                  <button class="button2 btn btn-primary cerrar b-r-xl">Cancelar</button>
                  <button class="button2 btn btn-primary b-r-xl" onclick="enviarCaso(this.innerText);" id="enviar"></button>
               </div>
            </div>
            <div class="footer">
               <div>
                  <strong>Todos los derechos reservados | </strong>SER Licorera 2014
               </div>
            </div>
         </div>
      </div>
      <!-- Mainly scripts -->
      <script src="js/jquery-3.1.1.min.js"></script>
      <script src="js/jquery-ui.js"></script>
      <script src="js/popper.min.js"></script>
      <script src="js/bootstrap.js"></script>
      <script src="js/plugins/metisMenu/jquery.metisMenu.js"></script>
      <script src="js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
      <!-- Custom and plugin javascript -->
      <script src="js/inspinia.js"></script>
      <script src="js/plugins/pace/pace.min.js"></script>
      <script src="js/funciones_generales.js"></script>
      <script src="js/plugins/sweetalert/sweetalert.min.js"></script>
      <script>
         const getApi="get_configuracion.php";
         const postApi="post_configuracion.php";
         //Empieza codigo de configuración del sistema
         function OcultarPass(valor){
           if(valor.checked){
             $(".campos").prop('disabled', false);
           }else{
             $(".campos").prop('disabled', true);
           }
         }
         async function GuardarDatos(){
           if(!document.getElementById('cbox').checked){
             mensajeError("Modifica algo antes de guardar");
             return;
           }
           try {
             var allinputs=$('#inputsDinamicos').find(':input');
             var data = "data=[";
             for (var i = 0; i < allinputs.length; i++) {
               data +='{ "id": '+allinputs[i].id+', "valor": "'+allinputs[i].value+'" },';
             }
             data=data.slice(0,-1);
             var result=await conexion("POST", 'RestApi/POST/'+postApi, data+"]");
             await mensajeSimple(result);
             $(".campos").prop('disabled', true);
             $("#cbox").prop('checked', false);

           } catch(error) {
             mensajeError(error);
           }
         }

         async function ObtenerDatos(){
           try {
             var url='RestApi/GET/'+getApi+"?configuracion=true";
             var result = await conexion("GET",url,"");
             var parsed =JSON.parse(result);
             var content="";
             for (var i = 0; i < parsed.length; i++) {
               if((i%2)==0){
                 content+= ' <div class="col-md-12 text-center  d-flex justify-content-center"> <div class="col-md-6 text-center"> <h5><label>  '+String(parsed[i].Descripcion)+':   </label> <input type="text" class="form-control campos b-r-xl" value="'+String(parsed[i].Val1)+'" name="'+String(parsed[i].IdConfig)+'" id="'+String(parsed[i].IdConfig)+'" disabled> </h5> </div>';
               }
               if((i%2)==1){
                 content+='<div class="col-md-6 text-center" > <h5><label>  '+parsed[i].Descripcion+':   </label> <input type="text" class="form-control campos b-r-xl" value="'+String(parsed[i].Val1)+'" name="'+String(parsed[i].IdConfig)+'" id="'+String(parsed[i].IdConfig)+'" disabled> </h5> </div> </div>';
               }
               if(i==(parsed.length-1) && (i%2)==0){
                 content+='</div>';
               }
             }
             $('#inputsDinamicos').append(content);
           } catch(error) {
             await mensajeError(error);
           }
         }
         //Termina el código de configuración del sistema
         //Empieza código de motivos
         $( function() {
           var options={
             open: function() {
                 $(this).closest(".ui-dialog")
                 .find(".ui-dialog-titlebar-close")
                 .removeClass("ui-dialog-titlebar-close").addClass("b-r-xl btn btn-danger");
             },
             autoOpen: false,
             height: 'auto',
             modal: true,
             closeOnEscape: true,
             show: {
               effect: "puff",
               duration: 800
             },
             hide: {
               effect: "drop",
               duration: 800
             },
             maxHeight: 570,
             minWidth: 500,
           };

           motivoTarea = $( "#motivoTarea" ).dialog(options);
         $( ".cerrar" ).button().on( "click", function() {
           motivoTarea.dialog( "close" );
         });


         } );

         async function CargarRazones(campo){
           try {
             $("#del").prop("disabled", true);
             $("#upd").prop("disabled", true);
             $("#add").prop("disabled", false);
             var url='RestApi/GET/'+getApi+"?motivo="+campo.value;
             var result = await conexion("GET",url,"");
             var parsed =JSON.parse(result);
             $('#razones').empty();
             for (i = 0; i < parsed.length; i++) {
               $('#razones').append($('<option>', {
                 value: parsed[i]["IdRazon"],
                 text: parsed[i]["Descripcion"]
               }));
             }
           } catch (e) {
             mensajeError(e);
           }
         }

         async function AgregarRazon(){
           try {
             if($('#eventos').val()===''){
               alert('Selecciona un evento primero');
               return;
             }
             if($('#razonNueva').val()===''){
               alert('Escribe una nueva razón primero');
               return;
             }
             var url='RestApi/POST/'+postApi;
             var result = await conexion("POST",url,"nuevoMotivo=true&evento="+$('#eventos').val()+"&razon="+$('#razonNueva').val());
             mensajeSimple(result);
             $('#razonNueva').val('')
             CargarRazones(document.getElementById('eventos'))
           } catch (e) {
             mensajeError(e);
           }finally{
             motivoTarea.dialog( "close" );
           }
         }

         function prepararDialogo(caso){
            $('#razonNueva').val('');
            $('#enviar').text(caso)
           if(caso==='Actualizar'){
             $('#mensaje').text('Ingresa la nueva descripción para este motivo');
             $('#razonNueva').val($('#razones :selected').text());
           }else if(caso==='Agregar'){
             $('#mensaje').text('Ingresa el nuevo motivo a agregar para '+$('#eventos :selected').text());
           }
           motivoTarea.dialog( "open" );
         }

         function enviarCaso(caso){
           if(caso==='Actualizar'){
             ActualizarRazon();
           }else if(caso==='Agregar'){
             AgregarRazon();
           }
         }

         async function ActualizarRazon(){
           try {
             if($('#eventos').val()===''){
               alert('Selecciona un evento primero');
               return;
             }
             if($('#razonNueva').val()===''){
               alert('Escribe una nueva razón primero');
               return;
             }
             var url='RestApi/POST/'+postApi;
             var result = await conexion("POST",url,"updateMotivo=true&descripcion="+$('#razonNueva').val()+"&razon="+$('#razones').val());
             mensajeSimple(result);
             $('#razonNueva').val('')
             CargarRazones(document.getElementById('eventos'))
           } catch (e) {
             mensajeError(e);
           }finally{
             motivoTarea.dialog( "close" );
           }
         }

         async function BorrarRazon(){
           try {
             if($('#razones').val()===''){
               alert('Selecciona un motivo primero');
               return;
             }
             if(await mensajeOpcional('Estas seguro de elemininar el motivo: '+$('#razones :selected').text())){
               var url='RestApi/POST/'+postApi;
               var result = await conexion("POST",url,"borrarMotivo=true&razon="+$('#razones').val());
               setTimeout(function() {
                 mensajeSimple(result);
               }, 500);
               $('#razonNueva').val('');
               CargarRazones(document.getElementById('eventos'))
             }
           } catch (e) {
             setTimeout(function() {
               mensajeError(e);
             }, 500);
           }
         }
         //Termina código de motivos

         $(document).ready(function(){
           permisos(["4"]);
           ObtenerDatos();
           $("#add").prop("disabled", true);
           $("#del").prop("disabled", true);
           $("#upd").prop("disabled", true);
         });
      </script>
   </body>
</html>
